// Prisma schema for Attendance Tracker (PostgreSQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  TEACHER
  REGISTRAR
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String?
  pin       String?
  role      UserRole @default(TEACHER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  logs                  Log[]
  recordedAttendance    Attendance[]   @relation("recordedBy")
  advisedSections       Section[]      @relation("adviserOfSection")
  approvedAbsenceNotes  AbsenceNote[]  @relation("approvedByUser")
}

model Grade {
  id           String    @id @default(cuid())
  name         String    @unique // e.g., "Grade 2"
  levelNumber  Int
  sections     Section[]

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Section {
  id          String       @id @default(cuid())
  name        String
  grade       Grade        @relation(fields: [gradeId], references: [id])
  gradeId     String
  adviser     User?        @relation("adviserOfSection", fields: [adviserId], references: [id])
  adviserId   String?

  enrollments Enrollment[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([gradeId, name])
  @@index([gradeId])
}

model Student {
  id          String     @id @default(cuid())
  lrn         String?    @unique
  firstName   String
  lastName    String
  sex         String?
  birthdate   DateTime?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  enrollments Enrollment[]
  attendance  Attendance[]
}

model Enrollment {
  id          String   @id @default(cuid())
  student     Student  @relation(fields: [studentId], references: [id])
  studentId   String
  section     Section  @relation(fields: [sectionId], references: [id])
  sectionId   String
  schoolYear  String   // e.g., "2025-2026"
  status      String   @default("ENROLLED")
  createdAt   DateTime @default(now())

  @@unique([studentId, sectionId, schoolYear])
  @@index([sectionId])
}

model Attendance {
  id                 String            @id @default(cuid())
  student            Student           @relation(fields: [studentId], references: [id])
  studentId          String
  studentName        String            // denormalized for quick viewing
  date               DateTime
  status             AttendanceStatus
  timeIn             DateTime?
  timeOut            DateTime?
  recordedBy         User              @relation("recordedBy", fields: [recordedByUserId], references: [id])
  recordedByUserId   String
  sectionIdSnapshot  String            // denormalized for quick filtering

  note         AbsenceNote?

  createdAt    DateTime           @default(now())

  @@unique([studentId, date])
  @@index([date])
  @@index([sectionIdSnapshot, date])
}

model AbsenceNote {
  id               String     @id @default(cuid())
  attendance       Attendance @relation(fields: [attendanceId], references: [id])
  attendanceId     String     @unique
  note             String
  studentName      String     // duplicate for reports
  attachmentUrl    String?
  approvedBy       User?      @relation("approvedByUser", fields: [approvedByUserId], references: [id])
  approvedByUserId String?
  approvedAt       DateTime?
  createdAt        DateTime   @default(now())
}

model Log {
  id         String   @id @default(cuid())
  user       User?    @relation(fields: [userId], references: [id])
  userId     String?
  action     String
  entityType String?
  entityId   String?
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // optionally store JSON snapshots
  before     Json?
  after      Json?
}
